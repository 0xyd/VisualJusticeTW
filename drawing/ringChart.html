<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<style type="text/css">
		html, body { height: 100%; width: 100%; margin: 0px; }
		body { background-color: #F7F9F9; }
		#PANEL { 
			height: 100%; 
			/*background-image: url('../Visual Design/elements/JusticeVisualizingLOGO_1_w300.png');
			background-position: 50% 50%;
			background-repeat: no-repeat;
			background-size: #f7f9f9;*/
		}
		#DISPLAY_PANEL, #CRTL_PANEL { display: inline-block; }
		#DISPLAY_PANEL { height: 100%; }
		/*#SKETCHPAD { padding-top: 10%; padding-left: 5%; /*padding-bottom: 5%;*/ }*/
		circle, path { cursor: pointer; }
		circle { fill: none; pointer-events: all; }
	</style>
	<link rel="stylesheet" type="text/css" href="../libs/bootstrap/css/bootstrap.min.css">
	<title>新入監人數</title>
</head>
<body class="container-fluid">
	<div id="PANEL" class="row">
		<div id="DISPLAY_PANEL" class="col-md-12">
			
		</div>
	</div>
	<script type="text/javascript" src="../libs/d3.js" charset="utf-8"></script>
	<script type="text/javascript" src="../libs/jquery-2.1.4.min.js" charset="utf-8"></script>
	<script type="text/javascript">

		/* Graph is the mother of the charts */
		var graphClass = function() {

			this.panel = (function() {
				return d3.select('#DISPLAY_PANEL')
					.append('svg')
					.attr('id', 'SKETCHPAD')
					.style({
						'padding-top':    '5%',
						'padding-left':   '5%',
						'padding-right':  '5%',
						'padding-bottom': '5%'
					})
					.style('height', '100%').style('width', '100%')
			})(),

			this.panelWidth = 
				parseInt(this.panel.style('width').replace('px', '')),

			this.panelHeight = 
				parseInt(this.panel.style('width').replace('px', '')),

			this.panelPadding = {
				top:     this.panel.style('padding-top').replace('px', ''),
				bottom:  this.panel.style('padding-bottom').replace('px', ''),
				left:    this.panel.style('padding-left').replace('px', ''),
				right:   this.panel.style('padding-right').replace('px', '')
			}
		}

		graphClass.prototype.readCSV = function(path) {
			return d3.csv(path)
		}

		/* Class for drawing rings chart */
		var ringGraphClass = function() {

			// Import ring graphClass into Graph Class
			graphClass.call(this);

			// Radius of the ring
			this.ringOuterRadius = (function(h, w) { 
				return Math.min(h,w)/ 2 
			})(this.panelWidth, this.panelHeight);

			// Ring Object
			this.ringsGroup = (function (self) {

				var _this = self;
			
				return d3.select('#SKETCHPAD').append('g')
					.attr('id', 'RING')
					.attr('transform', function(d) {

						// Put the ring at the center of the panel
						return 'translate(' + 
							(
								_this.panelWidth / 2 - 
								_this.panelPadding.left
							)
							+ ',' + 
							(
								_this.panelHeight / 2 -
								_this.panelPadding.top							
							) 
							+ ')'
					});
		})(this);

			// Partition of the rings
			this.ringPartition = 
				d3.layout.partition()
					.sort(null)
					.size([ 2*Math.PI, this.ringOuterRadius*this.ringOuterRadius ])
					.value(function(d) { return d.value }),

			// Arc of the rings
			this.arc = d3.svg.arc()
				.startAngle(function(d) { return d.x })
				.endAngle(function(d) { return d.x + d.dx })
				.innerRadius(function(d) { return Math.sqrt(d.y) })
				.outerRadius(function(d) { return Math.sqrt(d.y + d.dy) });
		}

		/* Inherit the ringGraphClass from the graph */
		ringGraphClass.prototype = Object.create(graphClass.prototype);
		ringGraphClass.prototype.constructor = ringGraphClass;

		/*  */
		ringGraphClass.prototype.drawRing = function(path) {
			
			this.readCSV(path)
					.row(function(d, i) { console.log(i); return d })
					.get(function(err, rows) {

						var dataset = [],
								color = {
									'不詳': '#6B96AD',
									'貧困無以為生': '#669FCC',
									'免足維持生活': '#5FA4D4',
									'小康之家': '#58ABD8',
									'中產之上': '#55B5DF'
								};

						for ( var i=0; i<rows.length; i++ ) {

							var row = rows[i];

							// Assign a custiomized pop function to a json data.
							row.pop = jsonPop;

							dataset.push(transtoPartitonFormat(row, '民國'));
						}

						console.log(this.ringOuterRadius);

					});
		}

		var ring = new ringGraphClass();

		ring.drawRing('/correction/新入監前家庭狀況.csv');


	// 	var svg = d3.select('#DISPLAY_PANEL')
	// 				.append('svg')
	// 				.attr('id', 'SKETCHPAD')
	// 				.style({
	// 					'padding-top':    '5%',
	// 					'padding-left':   '5%',
	// 					'padding-right':  '5%',
	// 					'padding-bottom': '5%'
	// 				})
	// 				.style("height", "100%").style("width", "100%"),

	// 			svgWidth = parseInt(svg.style('width').replace('px', '')),
	// 			svgHeight = parseInt(svg.style('height').replace('px', '')),
	// 			svgPadding = {
	// 				top:     svg.style('padding-top').replace('px', ''),
	// 				bottom:  svg.style('padding-bottom').replace('px', ''),
	// 				left:    svg.style('padding-left').replace('px', ''),
	// 				right:   svg.style('padding-right').replace('px', '')
	// 			},

	// 			radius = Math.min(svgWidth-svgPadding.left, svgHeight-svgPadding.top) / 2,
				
	// 			sunBurstChrt = svg.append('g')
	// 				.attr('id', 'SUNBURST')
	// 				.attr('transform', function(d) {
	// 					return 'translate(' + 
	// 						(
	// 							svgWidth / 2 - 
	// 							svgPadding.left
	// 						)
	// 						+ ',' + 
	// 						(
	// 							svgHeight / 2 -
	// 							svgPadding.top							
	// 						) 
	// 						+ ')'
	// 				}),

	// 			partition = d3.layout.partition()
	// 				.sort(null)
	// 				.size([ 2*Math.PI, radius*radius ])
	// 				.value(function(d) { return d.value }),

	// 			arc = d3.svg.arc()
	// 				.startAngle(function(d) { return d.x })
	// 				.endAngle(function(d) { return d.x + d.dx })
	// 				.innerRadius(function(d) { return Math.sqrt(d.y) })
	// 				.outerRadius(function(d) { return Math.sqrt(d.y + d.dy) }),

	// 			color = {
	// 				'不詳': '#6B96AD',
	// 				'貧困無以為生': '#669FCC',
	// 				'免足維持生活': '#5FA4D4',
	// 				'小康之家': '#58ABD8',
	// 				'中產之上': '#55B5DF'
	// 			};


	// 	sketchSunburst('/correction/新入監前家庭狀況.csv');

	// 	function sketchSunburst(path) {

	// 		d3.csv(path)
	// 			.row(function(d) { return d })
	// 			.get(function(error, rows) {

	// 				var dataset = [];

	// 				for ( var i=0; i<rows.length; i++ ) {
	// 					var row = rows[i];

	// 					// Assign a custiomized pop function to a json data.
	// 					row.pop = jsonPop;

	// 					dataset.push(transtoPartitonFormat(row, '民國'));
	// 				}

	// 				var p = new Promise(function(resolve, reject) {
	// 					var path = sunBurstChrt.datum(dataset[0]).selectAll('path')
	// 						.data(partition.nodes)
	// 						.enter().append('path')
	// 							.attr(
	// 								'id', 
	// 								function(d) { return d.depth ? null : 'CENTROID'; }
	// 							)
	// 							.attr('d', arc)
	// 							.style(
	// 								'fill',
	// 								function(d, i) {
	// 									// Make the first sector (central one) white
	// 									if ( i === 0 ) return '#fff'

	// 									else {
	// 										if ( i === dataset[0].children.length-1 ) 
	// 											resolve((function() {
	// 												return d3.select('#CENTROID')
	// 											})());
	// 										for ( var key in color ) if ( d.name === key ) return color[key]
	// 									}
	// 								}
	// 							)
	// 	  					.style('fill-rule', 'evenodd');
	// 				});

	// 				p.then(function(circle) { 

	// 						var sunBurstChrt_2 = svg.append('g')
	// 								.attr('id', 'SUNBURST')
	// 								.attr('transform', function(d) {
	// 									return 'translate(' + 
	// 										(
	// 											svgWidth / 2 - 
	// 											svgPadding.left
	// 										)
	// 										+ ',' + 
	// 										(
	// 											svgHeight / 2 -
	// 											svgPadding.top							
	// 										) 
	// 										+ ')'
	// 								}), 

	// 							radius = Math.min(
	// 								circle.node().getBBox().height, 
	// 								circle.node().getBBox().width) / 2,

	// 							partition = d3.layout.partition()
	// 								.sort(null)
	// 								.size([ 2*Math.PI, radius*radius ])
	// 								.value(function(d) { return d.value }),

	// 							color = {
	// 								'累犯': '#F16B23',
	// 								'再犯': '#F27422',
	// 								'初犯': '#ED8222'									
	// 							};

	// 						// Remove the previous circle once we create the new paths.
	// 						circle.remove();

	// 							d3.csv('/correction/__新入監犯罪次數與種類.csv')
	// 								.row(function(d) { return d })
	// 								.get(function(error, rows) {
										
	// 									var dataset = [];

	// 									for ( var i=0; i<rows.length; i++ ) {
	// 										var row = rows[i];
	// 										row.pop = jsonPop;
	// 										dataset.push(transtoPartitonFormat(row, '民國'));
	// 									}

	// 										var path = sunBurstChrt_2.datum(dataset[0]).selectAll('path')
	// 											.data(partition.nodes)
	// 											.enter().append('path')
	// 												.attr(
	// 													'id', 
	// 													function(d) { 
	// 														return d.depth ? null : 'CENTROID_2'; 
	// 													}
	// 												)
	// 												.attr('d', arc)
	// 												.style(
	// 													'fill',
	// 													function(d, i) {
	// 														// Make the first sector (central one) white
	// 														if ( i === 0 ) return '#fff'
	// 														for ( var key in color ) if ( d.name === key ) return color[key]
	// 													}
	// 												)
	// 	  										.style('fill-rule', 'evenodd');
	// 								});
	// 				});
	// 			});
	// }

	/* A function allows json data to pop a value with specific key. */
	function jsonPop(key) {

		var type = Object.prototype.toString.call(this).slice(8, -1);
							
		if ( type === 'Object' ) {
			for ( var k in this ) {
				if ( k === key ) { 

					var val = this[k];
					
					delete this[key]
					return val
				}
			}
		}
		else return undefined
	}

	/* 
		A function construct the a data format ({parent: '...', children: '...'}) 
		which is easily transformed into partitions 
	*/
	function transtoPartitonFormat(obj, popKey) {

		return {
			name: obj.pop(popKey),
			children: 
				(function(d) {

					var ary = [];
						
					for ( var key in d ) {  
						var _d = {};
						if ( Object.prototype
									.toString.call(d[key]).slice(8, -1) 
								!== 'Function' 
						) {
							_d['name'] = key;
							_d['value'] = parseInt(d[key]);
							ary.push(_d);
						}
					}
					return ary
				})(obj)
		}
	}
	</script>
</body>
</html>