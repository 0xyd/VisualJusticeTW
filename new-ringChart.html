<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<style type="text/css">
		html, body { height: 100%; width: 100%; margin: 0px; }
		body { background-color: #F7F9F9; }
		#PANEL { 
			height: 100%; 
			/*background-image: url('../Visual Design/elements/JusticeVisualizingLOGO_1_w300.png');
			background-position: 50% 50%;
			background-repeat: no-repeat;
			background-size: #f7f9f9;*/
		}
		#DISPLAY_PANEL, #CRTL_PANEL { display: inline-block; }
		#DISPLAY_PANEL { height: 100%; }
		circle, path { cursor: pointer; }
		circle { fill: none; pointer-events: all; }
	</style>
	<link rel="stylesheet" type="text/css" href="./libs/bootstrap/css/bootstrap.min.css">
	<title>新入監人數</title>
</head>
<body class="container-fluid">
	<div id="PANEL" class="row">
		<div id="DISPLAY_PANEL" class="col-md-12">
			
		</div>
	</div>
	<script type="text/javascript" src="./libs/d3.js" charset="utf-8"></script>
	<script type="text/javascript" src="./libs/jquery-2.1.4.min.js" charset="utf-8"></script>
	<script type="text/javascript">

		var color = {

			'新入監前家庭狀況': {
				'不詳': '#6B96AD',
				'貧困無以為生': '#669FCC',
				'免足維持生活': '#5FA4D4',
				'小康之家': '#58ABD8',
				'中產之上': '#55B5DF'
			},

			'新入監犯罪次數與種類' : {
				'累犯': '#F16B23',
				'再犯': '#F27422',
				'初犯': '#ED8222'	
			},

			'新入監前教育程度': {
				'大專以上': '#61B045',
				'高中職': '#6EBE44',
				'國中': '#78C14A',
				'國小': '#87C66A',
				'自修': '#8CBC71',
				'不識字': '#8AB276',
				'不詳': '#8AA679'
			},

			'歷年新入監年齡歷年統計': {
				'14 ~ 18': '#A885A4',
				'18 ~ 20': '#AA77A2',
				'20 ~ 24': '#B26DA5',
				'24 ~ 30': '#B765A5',
				'30 ~ 40': '#B9529E',
				'40 ~ 50': '#B5479A',
				'50 ~ 60': '#AD3C96',
				'60 ~ 70': '#A93393',
				'70 ~ 80': '#A42D91',
				'80 ~': '#9F238E'			
			}
		};

		/* Graph is the mother of the charts */
		var graphClass = function() {

			this.panel = (function() {
				return d3.select('#DISPLAY_PANEL')
					.append('svg')
					.attr('id', 'SKETCHPAD')
					.style({
						'padding-top':    '5%',
						'padding-left':   '5%',
						'padding-right':  '5%',
						'padding-bottom': '5%'
					})
					.style('height', '100%').style('width', '100%')
			})(),

			this.panelWidth = 
				parseInt(this.panel.style('width').replace('px', '')),

			this.panelHeight = 
				parseInt(this.panel.style('height').replace('px', '')),

			this.panelPadding = {
				top:     this.panel.style('padding-top').replace('px', ''),
				bottom:  this.panel.style('padding-bottom').replace('px', ''),
				left:    this.panel.style('padding-left').replace('px', ''),
				right:   this.panel.style('padding-right').replace('px', '')
			}
		}

		graphClass.prototype.readCSV = function(path) {
			return d3.csv(path)
		}

		/* Class for drawing rings chart */
		var ringGraphClass = function() {

			var self = this;

			// Import ring graphClass into Graph Class
			graphClass.call(this);

			// Core radius of the ring sequence
			this.coreRadius = 100;

			// Outer Radius of the ring sequence
			this.shellRadius = (function(h, w) { 
				return Math.min(h,w)/ 2 
			})(
				this.panelWidth - this.panelPadding.left, 
				this.panelHeight - this.panelPadding.top
			);

			// The drawing ring inner radius 
			this.ringInnerRadius = this.coreRadius;

			// Delta of the ring radius
			this.ringDelta = 0;

			// The gap between each ring
			this.ringGap = 2;

			// Ring Group for collecting ring Objects
			this.ringGroup = [];

			// A variable for storing Year value in ROC
			this.rocYr = null;

			// Count for the number of the ring
			this.countRing = 0;

			this.ringNumber = null;

			this.dataInfoView = {
				textArea: null,
				percentage: null,
				categoryName: null,
				itemName: null,
				itemNumber: null
			};
		}

		/* Inherit the ringGraphClass from the graph */
		ringGraphClass.prototype = Object.create(graphClass.prototype);
		ringGraphClass.prototype.constructor = ringGraphClass;

		ringGraphClass.prototype.ringConstructor = function(source, innerR, outerR) {

			var ring = function(iR, oR, s) {

				// Set the source of the data
				this.dataSource = s;

				// Define the basic of the ring
				this.outerRadius = oR;
				this.innerRadius = iR;

				// Define the way we dipict the ring
				this.partition = 
					d3.layout.partition()
						.sort(null)
							.size([ 2*Math.PI, this.outerRadius*this.outerRadius ])
							.value(function(d) { return d.value });

				this.arc =
					d3.svg.arc()
						.startAngle(function(d) { return d.x })
						.endAngle(function(d) { return d.x + d.dx })
						.innerRadius(this.innerRadius)
						.outerRadius(this.outerRadius);
			};

			var r = new ring(innerR, outerR, source);

			return r
		}

		ringGraphClass.prototype.calRadiusDelta = function(categoryNum) {

			this.ringDelta = 
				(this.shellRadius - 
				 	this.coreRadius - 
				 		(categoryNum - 1) * this.ringGap) / categoryNum;

		}

		/* Select the year in ROC */
		ringGraphClass.prototype.selectROCYr = function(yr) {

			var date = new Date();

			// The data of current year won't be published until the next year
			this.rocYr = ( yr >= 75 && (date.getFullYear()-1911-1) > yr ) ? yr: null;
		}

		/* Row Index of data of ROC year */
		ringGraphClass.prototype.selectRow = function() {
			if ( this.rocYr ) return this.rocYr-75
			else return null
		}

		/*  */
		ringGraphClass.prototype.drawRing = function(ringObj) {

			var self = this,
				isYrSelected = this.rocYr ? true: false,
				keywords = ringObj.dataSource.match(/[\u4e00-\u9fa5]+/),
				_color = keywords ? color[keywords]: null;
			// console.log(_color);
			this.readCSV(ringObj.dataSource)
				.row(function(d, i) {
					if ( isYrSelected ) if ( i === self.selectRow() ) return d
					else return null
				})
				.get(function(err, selectedRows) {

					var selectedRow = 
							selectedRows.length === 1 ? 
								selectedRows[0]: null;
					
					if (selectedRow) {

						selectedRow.pop = jsonPop;
						selectedRow = transtoPartitonFormat(selectedRow, '民國');
						
						self.panel.append('g')
							.attr('class', 'RING')
							.attr('transform', function() {

									// Put the ring at the center of the panel
									return 'translate(' + 
										(
											self.panelWidth / 2 - 
											self.panelPadding.left
										)
										+ ',' + 
										(
											self.panelHeight / 2 -
											self.panelPadding.top							
										) 
										+ ')'
								})
							.datum(selectedRow)
								.selectAll('path')
									.data(ringObj.partition.nodes)
								.enter()
									.append('path')
										.attr('d', ringObj.arc)
										// Working spot
										.style('fill', function(d, i) {
											console.log(d.name);
											return color[keywords][d.name] || null
										})
										.style('fill-rule', 'evenodd');
								// .on('mouseover', self._displayData);

					}
				})
			}

		ringGraphClass.prototype.drawMultiRings = function(paths) {

			var self = this,
				l = paths.length,
				_rings = [];

			this.calRadiusDelta(l);
			
			for ( var i = 0; i < l; i++ ) {
				
				_rings.push({

					path:
						paths[i],

					innerRadius: 
						this.coreRadius + 
							(i-1) * this.ringGap + 
								(i-1) * this.ringDelta, 

					outerRadius: 
						this.coreRadius + 
							(i-1) * this.ringGap + 
								i * this.ringDelta
				});
			}

			var _rings_l = _rings.length;

			for (var j = 0; j < _rings_l; ++j) {
				
				var r = _rings.shift();
				
				this.ringGroup.push(
					this.ringConstructor(
						r.path, 
						r.innerRadius, 
						r.outerRadius));
			}

			for (var k = 0; k < this.ringGroup.length; ++k) 
				this.drawRing(this.ringGroup[k]);
		}

		// Add the hover event listeners to the rings and their paths.
		ringGraphClass.prototype._displayData = function() {

			var self = ringGraph,
					selectedArc = this;
					
			function __calPercentage() {
				var calResult = 
					selectedArc.__data__.dx/(2*Math.PI)*100;

				if (calResult < 100 && calResult >= 1) 
					return calResult.toPrecision(3) + '%' 
				else if ( calResult < 1 ) 
					return calResult.toPrecision(2) + '%'
			}

			/* 
				Gradient effect allows the ring the mouse hovering display clearly and 
				the rest of the rings become blur. 
				Besides, the arc of the hovering ring has two styles:
				the one mouse is hovering is solid and the other turns to be transparent.
			*/
			function __ringGradient() {

				var 
					arcBrothers = 
						Array.from(selectedArc.parentNode.childNodes)
							.filter(function(arc) { 
								
								if ( 
									arc !== selectedArc &&
									arc.getAttribute('class') === null  
								) return arc

								return null
							}),

					otherRings = 
						Array.from(selectedArc.parentNode.parentNode.childNodes)
							.filter(function(ring) { 
								if ( 
									ring.getAttribute('id') !== 'INFOVIEW' &&
									ring !== selectedArc.parentNode
								) return ring

							});

					selectedArc.style.opacity = '1';
					selectedArc.parentNode.opacity = '1';

					for ( var i in arcBrothers ) 
						arcBrothers[i].style.opacity = '0.8';
					for ( var i in otherRings ) {
						var children = Array.from(otherRings[i].childNodes);
						for ( var j in children )
							children[j].style.opacity = '0.3';
					}
			}

			// Build infoview group containing the text infomation
			function __buildInfoView() {
				var p = new Promise(function(resolve, reject) {
					self.dataInfoView.textArea = 
						d3.select('#SKETCHPAD').append('g')
							.attr('id', 'INFOVIEW')
							.attr(
								'transform',
									function(d) {
										resolve();
											return 'translate('
											+
											(self.panelWidth/2-self.panelPadding.left-60)
												+ ',' +
											(self.panelHeight/2-self.panelPadding.top-15)
											+ ')'
										}	
								);
				});
				return p
			}

			// Add more text infomation
			function __moreInfoText(partName, fontSize, xPos, yPos, txtInput) {

				var p = new Promise(function(resolve, reject) {
					self.dataInfoView[partName] = 
						d3.select("#INFOVIEW").append('text')
							.attr('font-size', fontSize)
							.attr('x', xPos)
							.attr('y', yPos)
						.text(txtInput)
							.call(function() {
								resolve();
							});
				});
				return p
			}

			// If the infoview is created beforehand
			if ( ringGraph.dataInfoView.textArea ) { 
				console.log(selectedArc.__data__);
				console.log(selectedArc.parentNode.childNodes[0].__data__);
				// Load or Update the infomation for display.
				ringGraph.dataInfoView.percentage.text(__calPercentage);
				ringGraph.dataInfoView.categoryName.text(
					selectedArc.parentNode.childNodes[0].__data__.category + ':');
				ringGraph.dataInfoView.itemName.text(selectedArc.__data__.name);
				ringGraph.dataInfoView.itemNumber.text(selectedArc.__data__.value);

				/* Gradient effect */
				__ringGradient();
				
			} else { // The infoview hasn't been built yet.

				var q = new queue();

				var t0 = q.taskConst(__buildInfoView, null),
						t1 = q.taskConst(
							__moreInfoText, 
							[
								'percentage', 
								'50px', 
								null,
								null,
								__calPercentage()
							]),
						t2 = q.taskConst(
							__moreInfoText,
							[
								'categoryName',
								'16px',
								-12.5,
								35,
								selectedArc.parentNode.childNodes[0].__data__.category + ':'
							]),
						t3 = q.taskConst(
							__moreInfoText,
							[
								'itemName',
								'16px',
								-12.5,
								55,
								selectedArc.__data__.name
							]),
						t4 = q.taskConst(
							__moreInfoText,
							[
								'itemNumber',
								'16px',
								-12.5,
								75,
								selectedArc.__data__.value
							]);

				q.pushTasks([t0, t1, t2, t3, t4]);
				q.queuing(__ringGradient);
			}
		}

		var dataPaths = [
					'/correction/新入監前家庭狀況.csv', 
					'/correction/新入監犯罪次數與種類.csv',
					'/correction/新入監前教育程度.csv',
					'/correction/歷年新入監年齡歷年統計.csv'
				],
				ringGraph = new ringGraphClass();

		ringGraph.selectROCYr(95);
		// ringGraph.calRadiusDelta(dataPaths.length);
		ringGraph.drawMultiRings(dataPaths);
		
	/* A function allows json data to pop a value with specific key. */
	function jsonPop(key) {

		var type = Object.prototype.toString.call(this).slice(8, -1);
							
		if ( type === 'Object' ) {
			for ( var k in this ) {
				if ( k === key ) { 

					var val = this[k];
					
					delete this[key]
					return val
				}
			}
		}
		else return undefined
	}

	/* 
		A function construct the a data format ({parent: '...', children: '...'}) 
		which is easily transformed into partitions 
	*/
	function transtoPartitonFormat(obj, popKey) {

		return {
			name: obj.pop(popKey),
			children: 
				(function(d) {

					var ary = [];
						
					for ( var key in d ) {  
						var _d = {};
						if ( Object.prototype
									.toString.call(d[key]).slice(8, -1) 
								!== 'Function' 
						) {
							_d['name'] = key;
							_d['value'] = parseInt(d[key]);
							ary.push(_d);
						}
					}
					return ary
				})(obj)
		}
	}

	var queue = function() {
		this.queueTasks = [];
	}
	queue.prototype.taskConst = function(fn, args) {
		return { f: fn, fArgs: args }
	}

	queue.prototype.push = function(task) {
		this.queueTasks.push(task);
	}

	queue.prototype.pushTasks = function(tasks) {
		for ( var i in tasks ) {
			this.queueTasks.push(tasks[i]);
		}
	}

	queue.prototype.shift = function() {
		return this.queueTasks.shift()
	}
	queue.prototype.queuing = function(complete) {

		var self = this,
				task = 
					(self.queueTasks !== []) ?
							self.shift() : null;

		// A p which is returned from a task object with promise 
		var p = (task) ? task.f.apply(this, task.fArgs): null;
		
		if (p) {
			// The p.then won't run util the state truns to be resolved.
			p.then(function() {
				self.queuing(complete);
			});
		} else {
			if (complete) {
				complete();
			}
		}
	}
	</script>
</body>
</html>