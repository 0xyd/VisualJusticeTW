"use strict";function c_pinLbl2XAxisMidPt(t,e,a,r){t.selectAll(".tick").attr("transform",function(t,n){return"translate("+(r+(2*n+1)*e/2+n*a)+",0)"})}function c_placeValOnBarHdV(t,e,a,r,n){for(var i=t[0],s=0;s<i.length;s++){var o=i[s].getBBox(),l=(o.width/2,o.height/2),d=parseInt(i[s].getAttribute("x")),p=parseInt(i[s].getAttribute("y")),c=2*l>a/2?a/2-.5*l*2:a/2-l/2;i[s].setAttribute("transform","rotate(90, "+d+", "+p+")translate("+e+","+-1*c+")")}}function listAncestorNodes(t){for(var e=t,a=[];e&&e.parentNode;)"BODY"!==e.tagName?(a.push(e.parentNode),e=e.parentNode):e=null;return a}function calOffsetFromOrigins(t,e){var a=0,r=0,n=/\d+px/;for(var i in t){var s=window.getComputedStyle(t[i],null);a+=parseInt(s["border-left"].match(n)[0].replace("px",""))+parseInt(s["padding-left"].replace("px",""))+parseInt(s["margin-left"].replace("px","")),r+=parseInt(s["border-top"].match(n)[0].replace("px",""))+parseInt(s["padding-top"].replace("px",""))+parseInt(s["margin-top"].replace("px",""))}return{X:a,Y:r}}function jsonPop(t){var e=Object.prototype.toString.call(this).slice(8,-1);if("Object"===e)for(var a in this)if(a===t){var r=this[a];return delete this[t],r}}function transtoPartitonFormat(t,e){return{name:t.pop(e),children:function(t){var e=[];for(var a in t){var r={};"Function"!==Object.prototype.toString.call(t[a]).slice(8,-1)&&(r.name=a,r.value=parseInt(t[a]),e.push(r))}return e}(t)}}function colorAdjust(t,e){var a=colorObj.hexToRgb(t);return 255-a.r>e?a.r+=e:255-a.g>e?a.g+=e:255-a.b>e&&(a.b+=e),"rgb("+a.r+", "+a.g+", "+a.b+")"}var $v=Velocity,queue=function(){this.queueTasks=[]};queue.prototype.taskConst=function(t,e){return{f:t,fArgs:e}},queue.prototype.push=function(t){this.queueTasks.push(t)},queue.prototype.pushTasks=function(t){for(var e in t)this.queueTasks.push(t[e])},queue.prototype.shift=function(){return this.queueTasks.shift()},queue.prototype.queuing=function(t){var e=this,a=e.queueTasks!==[]?e.shift():null,r=a?a.f.apply(this,a.fArgs):null;r?r.then(function(){e.queuing(t)}):t&&t()};var colorClass=function(){this.bar={"合計發生件數":"#70C1B3","重大竊盜發生件數":"#F25F5C","普通竊盜發生件數":"#FFE066","汽車竊盜發生件數":"#247BA0","機車竊盜發生件數":"#2C5B26","重大竊盜破獲件數":"#9BC53D","重大竊盜尚未破獲件數":"#E55934","普通竊盜破獲件數":"#5BC0EB","普通竊盜尚未破獲件數":"#FA7921","汽機車竊盜案件":"#00A8E8","汽車竊盜破獲件數":"#EF233C","汽車竊盜尚未破獲件數":"#EDF2F4","汽車竊盜破獲率":"#0CCA4A","汽車竊盜嫌疑犯人數":"#F24B48","機車竊盜破獲件數":"#35C3D6","機車竊盜尚未破獲件數":"#FF1654","機車竊盜嫌疑犯人數":"#FFD000","被告人數":"#FC7B29","死刑":"#C20446","無期徒刑":"#FD9C3C","有期徒刑":"#E5404C","拘役":"#FFB14A","罰金":"#F68989","緩刑人數":"#9F89F4","免刑":"#53B4C4","無罪":"#2BA608","不受理":"#646561","累犯人數":"#D13F37","保安處分人數":"#809176","本年執行人數":"#BA0F30","本年入監人數":"#C41F3A","新入監人數":"#61B045","上年底留監人數":"#E9C247","本年出獄人數":"#F16B23","本年年底留監人數":"#55B5DF","案件數":"#4979BC","舊受":"#5C4491","新受":"#4CA0E0","終結":"#3B8AE5","未結":"#822979","平均每法官每月辦結件數":"#E71D36","終結案件中平均一件所需日數":"#FF9F1C","上訴案件維持率":"#2D73C4","抗告案件維持率":"#169976","累犯":"#E5404C","再犯":"#F16B23","初犯":"#F68989"},this.line={"本年執行人數":"#BA0F30","本年入監人數":"#C41F3A","新入監人數":"#61B045","上年底留監人數":"#E9C247","本年出獄人數":"#F16B23","本年年底留監人數":"#55B5DF"},this.rings=[{name:"新入監前家庭狀況",value:{"不詳":"#6B96AD","貧困無以為生":"#669FCC","免足維持生活":"#5FA4D4","小康之家":"#58ABD8","中產之上":"#55B5DF"}},{name:"新入監犯罪次數與種類",value:{"累犯":"#F16B23","再犯":"#F27422","初犯":"#ED8222"}},{name:"新入監前教育程度",value:{"大專以上":"#61B045","高中職":"#6EBE44","國中":"#78C14A","國小":"#87C66A","自修":"#8CBC71","不識字":"#8AB276","不詳":"#8AA679"}},{name:"歷年新入監年齡歷年統計",value:{"14 ~ 18":"#A885A4","18 ~ 20":"#AA77A2","20 ~ 24":"#B26DA5","24 ~ 30":"#B765A5","30 ~ 40":"#B9529E","40 ~ 50":"#B5479A","50 ~ 60":"#AD3C96","60 ~ 70":"#A93393","70 ~ 80":"#A42D91","80 ~":"#9F238E"}}]};colorClass.prototype.hexToRgb=function(t){var e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:null};var colorObj=new colorClass,graphClass=function(){this.pad=null,this.padHeight=null,this.padWidth=null,this.padPadding=null,this.xAxis=null,this.yAxis=null};graphClass.prototype.initializeAPad=function(){return this.pad=function(){return d3.select("#DATABOARD-vizLayer").append("svg").attr("id","SKETCHPAD").style({"padding-top":"5%","padding-left":"5%","padding-right":"5%","padding-bottom":"5%"}).style("height","100%").style("width","100%")}(),this.padWidth=parseInt(this.pad.style("width").replace("px","")),this.padHeight=parseInt(this.pad.style("height").replace("px","")),this.padPadding={top:this.pad.style("padding-top").replace("px",""),bottom:this.pad.style("padding-bottom").replace("px",""),left:this.pad.style("padding-left").replace("px",""),right:this.pad.style("padding-right").replace("px","")},this},graphClass.prototype.readCSV=function(t){return d3.csv(t)},graphClass.prototype._dataFiltering=function(t,e){for(var a in t)if(""===t[a])return null;return t},graphClass.prototype._setOrdinalXScale=function(t,e){this.xScale=d3.scale.ordinal().domain(t.map(function(t){return e?t[e]:t})).rangeBands([0,this.chartWidth])},graphClass.prototype._setXAxis=function(t){this.xAxis=d3.svg.axis().scale(this.xScale).orient(t)},graphClass.prototype._setLinearYScale=function(t,e){this.yScale=d3.scale.linear().domain([0,d3.max(t,function(t){return e?parseFloat(t[e]):t})]).rangeRound([this.chartHeight,0])},graphClass.prototype._setYPctScale=function(t,e){this.yScale=d3.scale.linear().domain([0,100]).rangeRound([this.chartHeight,0])},graphClass.prototype._setYAxis=function(t,e,a){function r(t){return Math.round(t/1e3)+"K"}var n=null,i=null,s=d3.max(e,function(t){return a?parseInt(t[a]):parseInt(t)});s>1e5?(n=1e5,i=r):s>1e4?(n=1e4,i=r):1e4>s&&s>2e3?n=1e3:2e3>s&&s>1e3?n=500:1e3>s?n=200:100>s&&(n=10),this.yAxis=d3.svg.axis().scale(this.yScale).orient(t).tickValues(d3.range(0,s,n)).tickFormat(i)},graphClass.prototype._setYPctAxis=function(t){this.yAxis=d3.svg.axis().scale(this.yScale).orient(t).tickValues(d3.range(0,100,20)).tickFormat(function(t){return t+"%"})},graphClass.prototype._createXAxis=function(t,e,a,r,n){this.pad.append("g").attr("class","x-axis").attr("transform","translate(0,"+this.chartHeight+")").call(this.xAxis).call(c_pinLbl2XAxisMidPt,a,r,n).append("text").attr("class","axis-name").attr("x",function(){return t.length*(a+r)+n}).attr("y","25").text(e)},graphClass.prototype._createYAxis=function(t){this.pad.append("g").attr("class","y-axis").call(this.yAxis).append("text").attr("class","axis-name").attr("transform","rotate(90) translate(0, -10)").text(t)},graphClass.prototype._removeYAxis=function(){this.pad.select("g.y-axis").remove()},graphClass.prototype._updateXAxisLabel=function(t){var e=this.pad.select("g.x-axis"),a=e.select("text.axis-name");if(a.html()!==t){var r={x:a.attr("x"),y:a.attr("y"),"class":a.attr("class")};a.remove(),e.append("text").text(t).attr({x:r.x,y:r.y,"class":r["class"]})}},graphClass.prototype._updateYAxisLabel=function(t){var e=this.pad.select("g.y-axis"),a=e.select("text.axis-name");if(a.html()!==t){var r={transform:a.attr("transform"),"class":a.attr("class")};a.remove(),e.append("text").text(t).attr({transform:r.transform,"class":r["class"]})}},graphClass.prototype.setOutPadding=function(t){return this.outPadding=t,this},graphClass.prototype.setStep=function(t){return this.step=t,this},graphClass.prototype._setHorSpace=function(t,e,a){return parseInt((this.chartWidth-a-e*t.length)/t.length)};var barGraphClass=function(){graphClass.call(this),this.chartHeight=null,this.chartWidth=null,this.bars=null,this.barsGroup=null,this.barWidth=null,this.barTxtGroup=null,this.stacks=null,this.stackGroup=null,this.outPadding=null,this.step=null,this.xScale=null,this.xAxis=null,this.yScale=null,this.yAxis=null};barGraphClass.prototype=Object.create(graphClass.prototype),barGraphClass.prototype.constructor=barGraphClass,barGraphClass.prototype.setChartSize=function(){return this.chartHeight=this.padHeight-this.padPadding.top-this.padPadding.bottom,this.chartWidth=this.padWidth-this.padPadding.left-this.padPadding.right,this},barGraphClass.prototype.setOutPadding=function(t){return this.outPadding=t,this},barGraphClass.prototype.setStep=function(t){return this.step=t,this},barGraphClass.prototype._setBarWidth=function(t){this.barWidth=parseInt((this.chartWidth-this.outPadding-this.step*t.length)/t.length)},barGraphClass.prototype._createBars=function(t,e,a,r){function n(t){this.bars=this.barsGroup.selectAll("rect").data(t).enter()}function i(t,r){var n=this.bars.append("rect").classed("bar",!0).attr({x:function(t,e){return o.outPadding+e*(o.barWidth+o.step)}}),i={y:function(t,r){return l?o.yScale(a[r]):o.yScale(t[e])},width:function(t,e){return o.barWidth},height:function(t,r){return l?o.chartHeight-o.yScale(a[r]):o.chartHeight-o.yScale(parseFloat(t[e]))},fill:function(t,a){return colorObj.bar[e]}};return t?n.attr({y:o.chartHeight,height:0,width:0}).transition().duration(1e3).attr(i).each("end",r):void n.attr(i).each(r)}function s(t,e){if(0!==e){var a=d3.select(this),r=this.previousSibling.__data__,n=Object.keys(t).map(function(e,a){return 0!==a?{name:e,val:function(){return t[e]-Math.ceil(t[e])<0?(parseFloat(t[e])-parseFloat(r[e])).toFixed(2):parseInt(t[e])-parseInt(r[e])}()}:void 0}).filter(function(t){return t?t:void 0});for(var i in n)a.attr("diff-"+n[i].name,n[i].val)}}var o=this,l=a.length>0?!0:!1;return this.barsGroup=this.pad.append("g").attr("class","bar-group"),n.apply(this,[t]),i.apply(this,[r,s]),this},barGraphClass.prototype._createStackBars=function(t,e,a){function r(t){i=i[0].length<t.length?i.data(t).enter():i.data(t).exit().remove()}function n(t,e){i[0].length===t.length&&i.append("g").classed("stack",!0)}this.stackGroup=this.pad.append("g").classed("stack-bars-group",!0);var i=this.pad.select("g.stack-bars-group").selectAll("g");r(t),n(t,null),this.stacks=i,this._stackBarProducer(a)},barGraphClass.prototype.updateStackBars=function(t,e,a){this._stackBarProducer(e,a).then(function(t){return t.each(function(t,e){this.__data__.year=this.parentNode.__data__["民國"]}),new tipClass}).then(function(t){t.appendStackBarMouseOver()})},barGraphClass.prototype.transitBarToStack=function(t,e,a){function r(t){s=s[0].length<t.length?s.data(t).enter():s.data(t).exit().remove()}function n(t){s[0].length===t.length&&s.append("g").classed("stack",!0)}this.bars=this.barsGroup.selectAll("rect.bar"),this.stackGroup=this.pad.append("g").classed("stack-bars-group",!0);var i=this,s=this.stackGroup.selectAll("g");if(a.url)var o=new Promise(function(t,e){i.readCSV(a.url).row(i._dataFiltering).get(function(e,a){t(a)})});var l=new Promise(function(t,e){(function(e){var a=[];return e.each(function(r,n){a.push(r),n===e[0].length-1&&t(a)}),a})(i.bars)}),d=new Promise(function(s,d){Promise.all([o,l]).then(function(o){for(var l=[],d=0,p=0;2>p;++p)o[p]&&d<o[p].length&&(d=o[p].length);for(var c=0;d>c;++c){for(var u={},h=0;2>h;++h)o[h]&&Object.assign(u,o[h][c]);l.push(u)}var f=[].concat(a.headers).concat(e.headers).filter(function(t){return null!==t&&void 0!==t}),g=i._mergedColVal(l,f);i._removeYAxis(),i._setLinearYScale(g,null),i._setYAxis("left",g,null),i._createYAxis(t),r(l),n(l),i.barsGroup.remove(),i.barTxtGroup.remove(),i._stackBarProducer(e,a).then(function(t){return t.each(function(t,e){this.__data__.year=this.parentNode.__data__["民國"]}),new tipClass}).then(function(t){t.appendStackBarMouseOver(),s()})})});return d},barGraphClass.prototype._stackBarProducer=function(t,e){this.stacks=this.stackGroup.selectAll("g.stack");var a=this,r=[].concat(t.headers,e.headers).filter(function(t){return null!==t&&void 0!==t}),n=new Promise(function(t,e){d3.selectAll("g.stack").each(function(e,n){function i(t){t.length>c[0].length?(h=!0,u=c.data(t).enter()):c.data(t).exit().remove()}function s(t){var e={x:a.outPadding+n*(a.barWidth+a.step),y:function(t,e){return t.y0},fill:function(t){return colorObj.bar[t.name]},width:a.barWidth,height:0};h?(c.attr(e).transition().duration(t).attr({height:function(t,e){return t.dy>=0?t.dy:0}}),u.append("rect").classed("stackbar",!0).attr(e).transition().duration(t).attr({height:function(t,e){return t.dy>=0?t.dy:0}})):c.attr(e).transition().duration(t).attr({height:function(t){return t.dy>=0?t.dy:0}})}if(r){var o=[],l=function(){var t=0;for(var n in r)t+=parseFloat(e[r[n]]);return a.chartHeight-a.yScale(t)}();for(var d in r){var p={};p.name=r[d],p.value=parseFloat(e[r[d]]),p.dy=a.chartHeight-a.yScale(p.value),0===parseInt(d)?p.y0=a.chartHeight-l:p.y0=o[parseInt(d)-1].y0+o[parseInt(d)-1].dy,o.push(p)}}var c=d3.select(this).selectAll("rect"),u=null,h=!1;i(o),s(500),this===this.parentNode.lastChild&&t(d3.selectAll("rect.stackbar"))})});return n},barGraphClass.prototype.transitBarToPCTStackBar=function(t,e,a,r){var n=this;return this.transitBarToStack(t,e,a).then(function(){n.transitPCTStackBar(t,r)})},barGraphClass.prototype.transitPCTStackBar=function(t,e){var a=this;this._removeYAxis(),this._setYPctScale(),this._setYPctAxis("left"),this._createYAxis(t);var r=[];this.stacks.each(function(t,e){r[e]=[],d3.select(this).selectAll("rect").each(function(t,a){r[e].push({year:t.year,name:t.name,value:t.value,y0:t.y0,dy:t.dy})})}),r=r.map(function(t){for(var e=function(t){var e=0;for(var a in t)e+=t[a].value;return e}(t),r=0;r<t.length;r++){var n=(t[r].value/e).toFixed(2);t[r].pct=n,0===r?t[r].y0_pct=0:t[r].y0_pct=t[r-1].dy_pct+t[r-1].y0_pct,r===t.length-1?t[r].dy_pct=function(e){for(var r=0,n=0;e>n;n++)r+=t[n].dy_pct;return a.chartHeight-r}(r):t[r].dy_pct=a.chartHeight-a.yScale(100*parseFloat(n))}return t});var n=new Promise(function(t,e){a.stacks.each(function(e,a){d3.select(this).selectAll("rect").data(r[a]).transition().duration(1e3).attr({y:function(t,e){return t.y0_pct},height:function(t,e){return t.dy_pct>=0?t.dy_pct:0}}).each("end",function(e,a){this===this.parentNode.lastChild&&t()})})});return n},barGraphClass.prototype.transitStackBarToBar=function(t,e,a){console.log(t);var r=this,n=[],i=new Promise(function(a,i){r.stacks.each(function(i,s){n.push(this.__data__);var o=r._checkColAccessableInOrigin(n,t),l=o?e:[],d=o?r._mergedColVal(n,l):[];d3.select(this).selectAll("rect.stackbar").transition().duration(2e3).attr({y:r.chartHeight,height:0,width:0}),this===this.parentNode.lastChild&&(r.stackGroup.remove(),a({isHeaderMerged:o,mergedData:d}))})});return i.then(function(e){r._removeYAxis(),r._setLinearYScale(e.mergedData.length>0?e.mergedData:n,e.isHeaderMerged?null:t),r._setYAxis("left",e.mergedData.length>0?e.mergedData:n,e.isHeaderMerged?null:t),r._createYAxis(a),r._createBars(n,t,e.mergedData,!1),r._markValOnBar(n,t,e.mergedData)}),i},barGraphClass.prototype.transitPCTSBarToSBar=function(t,e,a,r){function n(t){return t.map(function(t){for(var e=0,a=0;a<t.length;++a)e+=t[a].value;return e})}var i=this,s=e.headers.concat(a.headers).filter(function(t,e){return null!==t&&void 0!==t});this._removeYAxis(),console.log("check up here: ",d3.select("y-axis").empty()),console.log("checj up y-axis: ",d3.select("y-axis"));var o=new Promise(function(o,l){var d=[];if(r){console.log("should not be here"),i.stacks.each(function(t,e){d[e]=[],d3.select(this).selectAll("rect").each(function(t,a){d[e].push(t)})});var p=n(d);i._setLinearYScale(p,null),i._setYAxis("left",p,null),i._createYAxis(t),i.stacks.each(function(t,e){d3.select(this).selectAll("rect").transition().duration(2e3).attr({y:function(t,e){return t.y0},height:function(t,e){return t.dy>=0?t.dy:0}}).each("end",function(t,e){this===this.parentNode.lastChild&&o(new tipClass)})})}else{console.log("should be here");var d=[];i.stacks.each(function(t,e){d[e]=[];for(var a in s)d[e].push({name:s[a],value:parseFloat(t[s[a]])})});var p=n(d);i._setLinearYScale(p,null),i._setYAxis("left",p,null),i._createYAxis(t),i._stackBarProducer(e,a).then(function(t){return t.each(function(t,e){this.__data__.year=this.parentNode.__data__["民國"]}),new tipClass}).then(function(t){t.appendStackBarMouseOver(),o()})}});return o},barGraphClass.prototype.transitPCTSBarToBar=function(t,e,a,r,n){var i=[];this.stacks.each(function(t,e){i.push(t)}),this.stackGroup.remove();var s=this._checkColAccessableInOrigin(i,e),o=s?this._mergedColVal(i,n):[];return this._setLinearYScale(o.length>0?o:i,s?null:e),this._removeYAxis(),this._setYAxis("left",o.length>0?o:i,s?null:e),this._createYAxis(t),this._createBars(i,e,o,!0),this._markValOnBar(i,e,s?o:null),new Promise(function(t,e){t()})},barGraphClass.prototype._markValOnBar=function(t,e,a){var r=this,n=a.length>0?!0:!1;this.barTxtGroup=this.pad.append("g").attr("id","BAR-TXTGROUP"),this.barTxtGroup.selectAll("text").data(t).enter().append("text").text(function(t,r){return n?a[r]:t[e]?t[e]:t}).attr("class","mark").attr("x",function(t,e){return r.outPadding+e*(r.barWidth+r.step)}).attr("y",function(t,i){return n?r.yScale(a[i]):t[e]?r.yScale(t[e]):r.yScale(t)}).call(c_placeValOnBarHdV,10,this.barWidth,this.step,this.outPadding)},barGraphClass.prototype.mappingData=function(t,e,a,r,n,i,s){var o=this,l=new Promise(function(n,i){o.readCSV(t).row(o._dataFiltering).get(function(t,i){console.log(i);var l=o._checkColAccessableInOrigin(i,r),d=l?o._mergedColVal(i,s):[];o._setBarWidth(i),o._setOrdinalXScale(i,e),o._setLinearYScale(d.length>0?d:i,l?null:r),o._setYAxis("left",d.length>0?d:i,l?null:r),o._setXAxis("bottom"),o._createXAxis(i,e,o.barWidth,o.step,o.outPadding),o._createYAxis(a),o._createBars(i,r,d,!0),o._markValOnBar(i,r,d),n({data:i,pad:o.pad,step:o.step,barWidth:o.barWidth,outPadding:o.outPadding})})});return l},barGraphClass.prototype._checkColAccessableInOrigin=function(t,e){if(t){var a=Object.keys(t[0]);for(var r in a)if(a[r]===e)return!1}return!0},barGraphClass.prototype._mergedColVal=function(t,e){return t.map(function(t,a){var r=0;for(var a in e)r+=parseFloat(t[e[a]]);return r})},barGraphClass.prototype.update=function(t,e,a){var r=this,n=new Promise(function(n,i){var s=r.pad.selectAll("rect"),o=r.pad.selectAll(".mark"),l=function(){for(var t=[],e=0;e<s[0].length;e++)t.push({x:s[0][e].getAttribute("x"),y:s[0][e].getAttribute("y")});return t}(),d=[],p=[];s.each(function(t,e){p.push(t)}),r._setLinearYScale(p,a),r._setYAxis("left",p,a),r._updateXAxisLabel(t),r._updateYAxisLabel(e),s.attr({width:function(t,e){return r.barWidth}}).transition().attr({y:function(t,e){return d.push({x:this.getAttribute("x"),y:r.yScale(parseFloat(t[a]))}),d[e].y},height:function(t){return r.chartHeight-r.yScale(parseFloat(t[a]))},fill:function(t,e){return colorObj.bar[a]}}).each("end",function(t,e){e===s[0].length-1&&n({data:p,pad:r.pad,step:r.step,barWidth:r.barWidth,outPadding:r.outPadding})}),o.transition().attr("x",function(t,e){var a=d[e].y-l[e].y;return parseInt(this.getAttribute("x"))+a}).text(function(t){return t[a]}),r.pad.selectAll(".y-axis").call(r.yAxis)});return n},barGraphClass.prototype.isInvisible=function(){return this.bars.style("opacity")?!0:void 0},barGraphClass.prototype.bePhantom=function(){this.bars.style("opacity",0),this.isBarHidden()&&this.beDisplayed()},barGraphClass.prototype.beVisible=function(){this.bars.style("opacity",1),this.isBarHidden()&&this.beDisplayed()},barGraphClass.prototype.hide=function(){this.bars.style("display","none")},barGraphClass.prototype.beDisplayed=function(){this.bars.style("display","inline")},barGraphClass.prototype.isBarHidden=function(){var t=this.bars.style("display");return"none"===t?!0:!1},barGraphClass.prototype._makeXGridLines=function(){return d3.svg.axis(this.xScale).orient("bottom")},barGraphClass.prototype._makeYGridLines=function(){return d3.svg.axis(this.yScale).orient("left")},barGraphClass.prototype.makeGrid=function(){this.pad.append("g").attr("class","grid").attr("transform",""),this.pad.append("g").attr("class","grid").attr("transform","")};var lineGraphClass=function(){graphClass.call(this),this.pad=null,this.padPadding=null,this.padHeight=0,this.padWidth=0,this.chartHeight=null,this.chartWidth=null,this.step=0,this.linePath=null,this.lineDots=null,this.areaUnderLine=null,this.dottedLine=d3.svg.line().x(function(t,e){return t.cx}).y(function(t,e){return t.cy}),this.dotSpace=null,this.xScale=null,this.xAxis=null,this.yScale=null,this.yAxis=null,this.area=null,this.dividedAreas=null,this.infoBoard={infoReset:function(){},emptyAll:function(){this.body.remove()}}};lineGraphClass.prototype=Object.create(graphClass.prototype),lineGraphClass.prototype.constructor=lineGraphClass,lineGraphClass.prototype.setChartSize=function(t){return this.chartHeight=t?t.padHeight-t.padPadding.top-t.padPadding.bottom:this.padHeight-this.padPadding.top-this.padPadding.bottom,this.chartWidth=t?t.padWidth-t.padPadding.left-t.padPadding.right:this.padWidth-this.padPadding.left-this.padPadding.right,this},lineGraphClass.prototype.plotBars=function(t,e,a,r,n){var i=this,s=new Promise(function(n,s){for(var o=a?a[0]:e.selectAll("rect")[0],l=d3.select("#SKETCHPAD").select("rect").attr("fill"),d=0;d<o.length;d++){var p=o[d].getBBox();t[d].dotX=p.x+r,t[d].dotY=p.y}var c=d3.svg.line().x(function(t){return t.dotX}).y(function(t){return t.dotY});i.linePath?i.linePath.datum(t).transition().attr("d",c).attr("stroke",colorAdjust(l,20)):i.linePath=i.pad.append("g").attr("class","line-group").append("path").attr("class","dotted-path").datum(t).attr("d",c).attr("fill","none").attr("stroke",colorAdjust(l,20)).attr("stroke-width",3),i.lineDots?i.lineDots.data(t).transition().attr("fill",colorAdjust(l,20)).attr("cx",function(t){return t.dotX}).attr("cy",function(t){return t.dotY}):i.lineDots=i.pad.append("g").attr("class","dots-cluster").selectAll("circle").data(t).enter().append("circle").attr("cx",function(t){return t.dotX}).attr("cy",function(t){return t.dotY}).attr("class","dots").attr("fill",colorAdjust(l,20)).attr("stroke-width",2).attr("stroke","#fff").attr("r",7),i.areaUnderLine?i.updateUnderArea(t,colorAdjust(l,40)):i.drawUnderArea(t,colorAdjust(l,40)),n({data:t,hexCode:l,line:i.linePath,dots:i.lineDots,area:i.areaUnderLine})});return s},lineGraphClass.prototype.initInfoBoard=function(){this.infoBoard=d3.select("#DATABOARD-vizLayer").append("div").attr("id","LINE-INFO-BOARD").attr("class","board")},lineGraphClass.prototype.inheritPad=function(t,e,a,r){return this.pad=t,this.padHeight=e,this.padWidth=a,this.padPadding=r,this},lineGraphClass.prototype.mappingData=function(t,e,a,r){var n=this,i=new Promise(function(i,s){n.readCSV(t).row(n._dataFiltering).get(function(t,s){n.dotSpace=n._setHorSpace(s,n.step,n.outPadding),n._setOrdinalXScale(s,e),n._setLinearYScale(s,r),n._setYAxis("left",s,r),n._setXAxis("bottom"),n._createXAxis(s,e,n.dotSpace,n.step,n.outPadding),n._createYAxis(a),n.lineDots=n.pad.append("g").attr("class","dots-cluster").selectAll("circle").data(s).enter().append("circle").attr("cx",function(t,e){return n.outPadding+(2*e+1)*n.dotSpace/2+e*n.step}).attr("cy",function(t,e){return n.yScale(t[r])}).attr({r:7,"class":"dots",fill:colorAdjust(colorObj.line[r],20),stroke:"#fff","stroke-width":2}).call(function(){var t=function(t){for(var e=[],a=0;a<t[0].length;a++)e.push({cx:parseInt(d3.select(t[0][a]).attr("cx")),cy:parseInt(d3.select(t[0][a]).attr("cy"))});return e}(this);n.linePath=n.pad.append("g").classed("line-group",!0).append("path").datum(t).attr({d:n.dottedLine,fill:"none","class":"line",stroke:colorObj.line[r],"stroke-width":3}),i()})})});return i},lineGraphClass.prototype.update=function(t,e,a,r){var n=this,i=new Promise(function(e,a){n.readCSV(t).row(function(t){return t}).get(function(t,a){function i(t){t.length>=o[0].length?o.data(t).enter().append("circle"):o.data(t).exit()}function s(t){o.transition().duration(t).attr({cy:function(t,e){return n.yScale(t[r])},fill:function(){return colorObj.line[r]}}).each("end",function(t,a){a===o[0].length-1&&e({circles:o[0]})})}n._setLinearYScale(a,r),n._setYAxis("left",a,r);var o=n.pad.select(".dots-cluster").selectAll("circle");n.pad.selectAll(".y-axis").call(n.yAxis),i(a),s(1e3)})});return i.then(function(t){var e=function(t){for(var e=[],a=0;a<t.length;a++)e.push({cx:parseInt(d3.select(t[a]).attr("cx")),cy:parseInt(d3.select(t[a]).attr("cy"))});return e}(t.circles);n.pad.select("g.line-group").select("path").datum(e).transition().duration(600).attr({d:n.dottedLine,stroke:colorObj.line[r]})}),i},lineGraphClass.prototype.fillArea=function(t,e){this.area=d3.svg.area().x(function(t){return t.dotX}).y0(this.chartHeight).y1(function(t){return t.dotY}),this.pad.append("path").datum(t).attr("fill",e).attr("d",this.area)},lineGraphClass.prototype.drawUnderArea=function(t,e){this.area=d3.svg.area().x(function(t){return t.dotX}).y0(this.chartHeight).y1(function(t){return t.dotY}),this.areaUnderLine=this.pad.append("g").attr("class","under-line-area-group").append("path").datum(t).attr("class","under-line-area").attr("fill",e).attr("d",this.area)},lineGraphClass.prototype.updateUnderArea=function(t,e){this.areaUnderLine.datum(t).transition().attr("d",this.area).attr("fill",e).style("opacity",.8)},lineGraphClass.prototype.isInvisible=function(){return this.linePath.style("opacity")?!0:void 0},lineGraphClass.prototype.hide=function(){return this.linePath.style("display","none"),this.lineDots.style("display","none"),this},lineGraphClass.prototype.beDisplayed=function(){return this.linePath.style("display","inline"),this.lineDots.style("display","inline"),this},lineGraphClass.prototype.isLineHidden=function(){var t=this.linePath.style("display");return"none"===t?!0:!1},lineGraphClass.prototype.displayUnderArea=function(){return this.areaUnderLine.style("display","inline"),this},lineGraphClass.prototype.hideUnderArea=function(){return this.areaUnderLine.style("display","none"),this},lineGraphClass.prototype.empty=function(){return this.linePath=null,this.lineDots=null,this.areaUnderLine=null,this},lineGraphClass.prototype.drawEvtMarkers=function(){var t="https://spreadsheets.google.com/tq?key=",e="1jAMtUHVlw_pqmlnyFrscqwy274CgmQQ9C0Kp3EXmoAY",a="&tqx=out:csv",r=this,n=this.lineDots[0].filter(function(t){return"circle"===t.tagName?t:void 0});this.readCSV(t+e+a).row(function(t,e){return 0!==e?t:void 0}).get(function(t,e){var a=e.map(function(t){return t["民國"]}),i=n.map(function(t){for(var e in a)if(t.__data__["民國"]===a[e])return t.__data__}).filter(function(t){return t?t:void 0});!function(){for(var t in n){var a=e.find(function(e){try{n[t].__data__["民國"]}catch(a){if(a instanceof TypeError)return null}return e["民國"]===n[t].__data__["民國"]});a?(n[t].__data__["司法事記"]=a["司法事記"],n[t].__data__.tag=a.tag,n[t].__data__.hasEvent=!0):(n[t].__data__.hasEvent=!1,n[t].__data__.tag="")}}();r.pad.select("g.x-axis").attr("transform").match(/\d+\.\d+/g);r.pad.append("g").attr("class","evt-marker-lines").selectAll("line").data(i).enter().append("line").attr("x1",function(t){return t.dotX}).attr("y1",function(t){return t.dotY}).attr("x2",function(t){return t.dotX}).attr("y2",function(t){return t.dotY-50<30?t.dotY+50:t.dotY-50}).attr("stroke","#333").attr("stroke-width",1).each(function(t,e){var a=d3.select(this);0===e&&r.pad.append("g").attr("class","evt-marker-names"),this.__data__.text=r.pad.select("g.evt-marker-names").append("text").attr("x",a.attr("x2")).attr("y",a.attr("y2")).text(a.node().__data__.tag).attr("fill","#08f")}).call(function(){var t=this[0].filter(function(t){return"line"===t.tagName?t:void 0});for(var e in n)n[e].__data__.hasEvent&&(n[e].__data__.line=d3.select(t.shift()))})})},lineGraphClass.prototype.isEvtMarkersExisted=function(){return this.pad.select("g.evt-marker-lines").empty()},lineGraphClass.prototype.emptyEvtMarkers=function(){this.pad.select("g.evt-marker-lines").remove(),this.pad.select("g.evt-marker-names").remove()},lineGraphClass.prototype.updateEvtMarkers=function(){d3.select("g.evt-marker-lines").selectAll("line").transition().duration(200).attr("x1",function(t){return t.dotX}).attr("y1",function(t){return t.dotY}).attr("x2",function(t){return t.dotX}).attr("y2",function(t){return t.dotY-50<30?t.dotY+50:t.dotY-50})};var ringGraphClass=function(){graphClass.call(this),this.coreRadius=100,this.ringInnerRadius=this.coreRadius,this.ringDelta=0,this.ringGap=2,this.ringGroup=[],this.rocYr=null,this.dataInfoView={textArea:null,percentage:null,categoryName:null,itemName:null,itemNumber:null},this.ringInfoBoard={statsBoard:{body:null,scale:null,info:[],infoIdx:0,infoReset:function(){return this.info=[],this.infoIdx=0,this},emptyAll:function(){this.body.remove(),this.scale=null,this.infoReset()},setScale:function(){var t=parseInt(this.body.style("width").replace("px",""));this.scale=d3.scale.linear().domain([0,d3.max(this.info[this.infoIdx].values,function(t){return t.value})]).rangeRound([0,.5*t])},storeInfo:function(t,e,a){for(var r=a.length,n={name:t,ringId:e,year:null,values:[]},i=0;r>i;++i)0===parseInt(i)?n.year=a[i].__data__.name:n.values.push({name:a[i].__data__.name,value:a[i].__data__.value});this.info.push(n)},update:function(){var t=this,e=this.info[this.infoIdx],a=t.body.select("#"+e.ringId+"-menu"),r=a.select("svg");t.setScale(),a.selectAll("svg > text").remove(),a.selectAll("rect").each(function(t,a){this.__data__=e.values[a]}).call(function(){this.transition().duration(600).attr("width",function(e,a){return t.scale(e.value)}).each("end",function(){t._markValText.call(this,{svg:r})})})},_markValText:function(){var t=arguments[0].svg,e=d3.select(this),a=this.__data__,r=parseInt(e.attr("width").replace("px","")),n=parseInt(e.attr("x")),i=parseInt(e.attr("y"));t.append("text").text(a.value).style("font-size","0.8em").attr("x",n+r+5).attr("y",i+12).attr("fill","#fff"),arguments[0].isInit&&arguments[0].isLast&&t.attr("default-height",i+30)}},percentageBoard:{body:null,emptyAll:function(){this.body.remove()},calVal:function(t){var t=100*t>.0999999999?(100*t).toFixed(1):'<span style="font-size: 0.4em;">&lt;</span> 0.1';return this.body.select(".board-body-txt").html(t),this},setTitle:function(t,e){return this.body.select(".board-body-title").text(t+":"+e),this}}}};ringGraphClass.prototype=Object.create(graphClass.prototype),ringGraphClass.prototype.constructor=ringGraphClass,ringGraphClass.prototype.init=function(){return this.shellRadius=function(t,e){return Math.min(t,e)/2}(this.padWidth-this.padPadding.left,this.padHeight-this.padPadding.top),this.ringInfoBoard.statsBoard.body=d3.select("#DATABOARD-vizLayer").append("div").classed("board",!0).attr("id","RING_STATS_BOARD").style("top","7%").style("left","7%"),this.ringInfoBoard.percentageBoard.body=d3.select("#DATABOARD-vizLayer").append("div").classed("board",!0).attr("id","RING_PERCENTAGE_BOARD").style("bottom","5%").style("left","7%"),this.ringInfoBoard.percentageBoard.body.append("section").attr("class","board-body board-body--centering").style("height","100%").call(function(){this.append("div").attr("class","board-body-title"),this.append("div").attr("class","board-body-txt")}),this},ringGraphClass.prototype.ringConstructor=function(t,e,a,r){var n=function(t,e,a,r){this.idName=t,this.dataSource=r,this.outerRadius=a,this.innerRadius=e,this.partition=d3.layout.partition().sort(null).size([2*Math.PI,this.outerRadius*this.outerRadius]).value(function(t){return t.value}),this.arc=d3.svg.arc().startAngle(function(t){return t.x}).endAngle(function(t){return t.x+t.dx}).innerRadius(this.innerRadius).outerRadius(this.outerRadius),this.pathOriginPos=[]},i=new n(t,a,r,e);return i},ringGraphClass.prototype._infoBoardRender=function(t){var e=this.ringInfoBoard.statsBoard,a=e.info,r=e.infoIdx,t=t?!0:!1,n=(parseInt(e.body.style("width").replace("px","")),colorObj.rings.find(function(t){return t.name===a[r].name?!0:void 0}));if(e.setScale(),t){e.info[e.infoIdx];e.update()}else e.body.append("div").attr("id",a[r].ringId+"-menu").attr("class","board-dropdown").html(function(){return'<div class="board-dropdown-header"><span class="title">'+a[r].name+'</span><span class="arrow"><div class="arrow-left"></div><div class="arrow-right"></div></span></div>'}).selectAll("div.board-dropdown").data([a[r]]).enter().append("div").attr("class","board-dropdown-menu").append("svg").selectAll("g").data(a[r].values).enter().append("g").append("text").text(function(t){return t.name}).attr("x",0).attr("y",function(t,e){return 22.5+25*(e>0?e:0)+"px"}).attr("font-size","0.8em").attr("fill","#fff").call(function(t){
var i=function(t){for(var e=[],a=t.length,r=0;a>r;++r)e.push(parseInt(d3.select(t[r]).style("width").replace("px","")));return Math.max.apply(null,e)}(t[0]),s=e.body.select("#"+a[r].ringId+"-menu svg");s.selectAll("rect").data(a[r].values).enter().append("rect").attr("height",15).attr("width",function(t,a){return e.scale(t.value)}).attr("default-color",function(t){return n.value[t.name]}).attr("fill",function(t){return n.value[t.name]}).attr("x",function(t,e){return 10+i+"px"}).attr("y",function(t,e){return 10+25*(e>0?e:0)+"px"}).call(function(t){for(var n=t[0],i=n.length,o=0;i>o;o++)o===i-1?e._markValText.call(n[o],{svg:s,isInit:!0,isLast:!0}):e._markValText.call(n[o],{svg:s,isInit:!0});"RING_3"===a[r].ringId?(e.body.attr("current-ring-data","RING_3"),s.attr("height",function(){return this.getAttribute("default-height"),this.getAttribute("default-height")+"px"})):(s.attr("height",0),d3.select("#"+a[r].ringId+"-menu").style("display","none"))})});e.infoIdx+=1},ringGraphClass.prototype.calRadiusDelta=function(t){this.ringDelta=(this.shellRadius-this.coreRadius-(t-1)*this.ringGap)/t},ringGraphClass.prototype.selectROCYr=function(t){var e=new Date;return this.rocYr=t>=75&&e.getFullYear()-1911-1>t?t:null,this},ringGraphClass.prototype.selectRow=function(){return this.rocYr?this.rocYr-75:null},ringGraphClass.prototype.drawRing=function(t){var e=this,a=this.rocYr?!0:!1,r=t.dataSource.name;this.readCSV(t.dataSource.url).row(function(t,r){return a?r===e.selectRow()?t:null:void 0}).get(function(a,n){function i(t,a){function r(t,e,a){t.style("display","block"),$v(e.node(),{height:e.attr("default-height")},{duration:400}),$v(a.node(),{rotateZ:"180deg"},{duration:400})}function n(t,e,a){t.style("display","none"),$v(e.node(),{height:0},{duration:400}),$v(a.node(),{rotateZ:"0deg"},{duration:400})}var i=e.ringInfoBoard.statsBoard.info.length,s=e.ringInfoBoard.statsBoard.info[0].ringId,o=e.ringInfoBoard.statsBoard.info[i-1].ringId,l=d3.select("#"+t).node(),d=d3.select("#"+t+"-menu"),p=d.select("div.board-dropdown-menu").select("svg"),c=d.select("div.board-dropdown-header").select("span.arrow"),u=d3.select("#"+s+"-menu"),h=u.select("div.board-dropdown-menu").select("svg"),f=u.select("div.board-dropdown-header").select("span.arrow"),g=d3.select("#"+o+"-menu"),y=g.select("div.board-dropdown-menu").select("svg"),v=g.select("div.board-dropdown-header").select("span.arrow");"expand"===a?($v(l,{opacity:1},{duration:400}),t!==o&&t!==s?("block"===u.style("display")?n(u,h,f):"block"===g.style("display")&&n(g,y,v),r(d,p,c)):t===o?r(d,p,c):t===s&&r(d,p,c)):"collapse"===a&&($v(l,{opacity:.6},{duration:400}),t!==o&&t!==s&&n(d,p,c))}var s=1===n.length?n[0]:null,o=function(t){var e=0;for(var a in t)e+=parseInt(t[a]);return e}(s);s&&(s.pop=jsonPop,s=transtoPartitonFormat(s,"民國"),e.pad.append("g").attr("id",t.idName).attr("class","RING").attr("transform",function(){return"translate("+(e.padWidth/9*6-e.padPadding.left)+","+(e.padHeight/2-e.padPadding.top)+")"}).style("stroke","#fff").style("opacity",.6).on("mouseenter",function(t,a){e.ringInfoBoard.statsBoard.body.attr("current-ring-data",this.id),i(this.id,"expand")}).on("mouseleave",function(t,e){i(this.id,"collapse")}).datum(s).selectAll("path").data(t.partition.nodes).enter().append("path").attr("d",t.arc).call(function(a){e.ringInfoBoard.statsBoard.storeInfo(r,t.idName,a[0]),e._infoBoardRender()}).style("fill",function(t,e){var a=colorObj.rings.findIndex(function(t){return t.name===r?!0:void 0});return colorObj.rings[a].value[t.name]}).style("fill-rule","evenodd").on("mouseenter",function(t,a){d3.select("#"+this.parentNode.id+"-menu").selectAll("rect").each(function(t,e){a===e+1&&d3.select(this).classed("selected",!0)}),d3.select(this).attr("stroke-width","5px").attr("stroke","#fff"),e.ringInfoBoard.percentageBoard.calVal(t.value/o).setTitle(r,t.name)}).on("mouseout",function(t,e){d3.select("#"+this.parentNode.id+"-menu").select("rect.selected").classed("selected",!1),d3.select(this).attr("stroke-width",null).attr("stroke",null)}).call(function(a){t.pathOriginPos=e._stashOriginPathPos(a[0])}))})},ringGraphClass.prototype.drawMultiRings=function(t){var e=t.length,a=[];this.calRadiusDelta(e);for(var r=0;e>r;r++)a.push({idName:"RING_"+r,path:t[r],innerRadius:this.coreRadius+(r-1)*this.ringGap+(r-1)*this.ringDelta,outerRadius:this.coreRadius+(r-1)*this.ringGap+r*this.ringDelta});for(var n=a.length,i=0;n>i;++i){var s=a.shift();this.ringGroup.push(this.ringConstructor(s.idName,s.path,s.innerRadius,s.outerRadius))}for(var o=0;o<this.ringGroup.length;++o)this.drawRing(this.ringGroup[o])},ringGraphClass.prototype.updateRings=function(){var t=!0,e=!1,a=void 0;try{for(var r,n=this.ringGroup[Symbol.iterator]();!(t=(r=n.next()).done);t=!0){var i=r.value;this.updateRing(i)}}catch(s){e=!0,a=s}finally{try{!t&&n["return"]&&n["return"]()}finally{if(e)throw a}}},ringGraphClass.prototype.updateRing=function(t){var e=this,a=this.selectRow(),r=this.rocYr?!0:!1,n=t.dataSource.name;this.readCSV(t.dataSource.url).row(function(t,e){return r?e===a?t:null:void 0}).get(function(a,r){var i=1===r.length?r[0]:null;i&&(i.pop=jsonPop,i=transtoPartitonFormat(i,"民國"),d3.select("#"+t.idName).datum(i).selectAll("path").data(t.partition.nodes).each(function(e,a){0!==a&&a<=t.pathOriginPos.length&&(e.x0=t.pathOriginPos[a-1].x0,e.dx0=t.pathOriginPos[a-1].dx0)}).call(function(a){"RING_0"==t.idName?e.ringInfoBoard.statsBoard.infoReset().storeInfo(n[0],t.idName,a[0]):e.ringInfoBoard.statsBoard.storeInfo(n[0],t.idName,a[0]),e._infoBoardRender(!0)}).transition().duration(500).call(function(){var t=(this[0].map(function(t,e){return e>0?{name:t.__data__.name,value:t.__data__.value}:void 0}).filter(function(t){return t?t:void 0}),d3.select(this.node().parentNode));t.transition().duration(500).style("opacity",1).transition().duration(1e3).style("opacity",.6)}).attrTween("d",function(e,a,r){if(a>0){var n=d3.interpolate({x:e.x0,dx:e.dx0},e);return function(a){var r=n(a);return e.x0=r.x,e.dx0=r.dx,t.arc(r)}}}).call(function(a){t.pathOriginPos=e._stashOriginPathPos(a[0])}))})},ringGraphClass.prototype._stashOriginPathPos=function(t){var e=[];for(var a in t)parseInt(a)>0&&e.push({x0:t[a].__data__.x,dx0:t[a].__data__.dx});return e},ringGraphClass.prototype.resetRings=function(){return this.ringGroup=[],this},ringGraphClass.prototype.removeBoards=function(){var t=this.ringInfoBoard.statsBoard,e=this.ringInfoBoard.percentageBoard;t.body&&t.emptyAll(),e.body&&e.emptyAll()};var tipClass=function(){var t=d3.select("#APP");this.dotTip=t?t.append("div").attr("id","DOT-TIP").attr("class","tip"):void 0,this.barTip=t?t.append("div").attr("id","BAR-TIP").attr("class","tip"):void 0,this._bTipH=null,this._bTipW=null};tipClass.prototype.initTips=function(){return this.dotTip=d3.select("#APP").append("div").attr("id","DOT-TIP").attr("class","tip"),this.barTip=d3.select("#APP").append("div").attr("id","BAR-TIP").attr("class","tip"),this},tipClass.prototype.appendDotMouseOver=function(t){var e=this,a=this._setOffset("DOT-TIP");d3.select("#SKETCHPAD").selectAll(".dots").on("mouseover",function(r){var n=parseInt(this.getAttribute("cx")),i=parseInt(this.getAttribute("cy"));e.dotTip.classed("display",!0).style("top",i+a.Y+"px").style("left",n+a.X+"px").html(function(){var e="民國 "+r["民國"]+"<br>"+t+": "+r[t];return'<span id="DOT-INFO">'+e+"</span>"}).call(function(t){e._correctPos("DOT-TIP")})}).on("mouseout",function(t){e.dotTip.classed("display",!1)})},tipClass.prototype.appendBarMouseOver=function(t){var e=this,a=this._setOffset("BAR-TIP");d3.select("#SKETCHPAD").selectAll(".bar").on("mouseenter",function(r){var n=d3.select(this),i=function(t){var e=n.attr("diff-"+t);return e?e:void 0}(t),s=parseFloat(this.getAttribute("x"))+parseFloat(this.getAttribute("width")/2),o=parseFloat(this.getAttribute("y"));e.barTip.classed("display",!0).style("top",o+a.Y+"px").style("left",s+a.X+"px").html(function(){var e="民國 "+r["民國"]+"<br>"+t+": "+r[t];return i?0>i?'<span id="BAR-INFO">'+e+'</span><span>較去年同期：</span><span><span class="down-arrow align"></span><span class="align">&nbsp;'+i+"</span></span>":'<span id="BAR-INFO">'+e+'</span><span>較去年同期：</span><span><span class="up-arrow align"></span><span class="align">&nbsp;'+i+"</span></span>":'<span id="BAR-INFO">'+e+"</span>"}).call(function(t){e._correctPos("BAR-TIP")._nodeSizeCorrect("BAR-TIP")})}).on("mouseout",function(t){e.barTip.classed("display",!1)})},tipClass.prototype.appendStackBarMouseOver=function(){var t=this,e=this._setOffset("BAR-TIP");d3.select("#SKETCHPAD").selectAll("rect.stackbar").on("mouseenter",function(a){var r=parseFloat(this.getAttribute("x"))+parseFloat(this.getAttribute("width")/2),n=parseFloat(this.getAttribute("y"));t.barTip.classed("display",!0).style("top",n+e.Y+"px").style("left",r+e.X+"px").html(function(){var t="民國 "+a.year+"<br>"+a.name+": "+a.value;return a.pct&&(t+="<br>"+(100*parseFloat(a.pct)).toFixed(2)+"%"),'<span id="BAR-INFO">'+t+"</span>"}).call(function(e){t._correctPos("BAR-TIP")._nodeSizeCorrect("BAR-TIP")})}).on("mouseout",function(e){t.barTip.classed("display",!1)})},tipClass.prototype._setOffset=function(t){var e=document.getElementById(t),a=listAncestorNodes(e),r=calOffsetFromOrigins(a,e),n=window.getComputedStyle(document.getElementById("DATABOARD_WRAPPER")),i=(window.getComputedStyle(document.getElementById("DATABOARD-vizLayer")),window.getComputedStyle(document.getElementById("SKETCHPAD"),null)),s=window.getComputedStyle(document.getElementById("HDR"),null);return r.X+=parseInt(n["padding-left"].replace("px",""))+parseInt(i["padding-left"].replace("px",""))+parseInt(s.width.replace("px","")),r.Y+=parseInt(n["padding-top"].replace("px",""))+parseInt(i["padding-top"].replace("px","")),r},tipClass.prototype._correctPos=function(t){var e=this,a=null,r=9,n=9/Math.sqrt(3);!function(){"DOT-TIP"===t?a=e.dotTip:"BAR-TIP"===t&&(a=e.barTip)}(),this._bTipH=a.node().offsetHeight,this._bTipW=a.node().offsetWidth;var i=parseInt(a.node().style.top.replace("px","")),s=parseInt(a.node().style.left.replace("px","")),o=i-a.node().offsetHeight-r,l=s-a.node().offsetWidth/2-n;return o>0&&l>0?a.classed("tip-before-display",!1).classed("tip-after-display",!0).style("top",o+"px").style("left",l+"px"):0>o&&(o=i+r,a.classed("tip-before-display",!0).classed("tip-after-display",!1).style("top",o+"px").style("left",l+"px")),this},tipClass.prototype._nodeSizeCorrect=function(t){var e=this;if("BAR-TIP"===t){var a=e.barTip.node().offsetHeight,r=e.barTip.node().offsetWidth;this.barTip.style("top",function(){var t=this.style.top;if(e._bTipH!==a){var r=parseInt(t.replace("px",""));return r+e._bTipH-a+"px"}return t}).style("left",function(){var t=this.style.left;if(e._bTipW!==r){var a=parseInt(t.replace("px",""));return a+e._bTipW/2-r/2+"px"}return t}).style("width",function(){return r+"px"})}else"DOT-TIP"===t&&console.log(this.dotTip.node().offsetHeight);return this};